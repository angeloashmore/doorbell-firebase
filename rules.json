{
  "rules": {
    ".read": "false",
    ".write": false,

    "billings": {
      ".read": "auth.uid === 'doorbell-firebase-server'",

      "users": {
        ".write": "auth.uid === 'doorbell-firebase-server'",

        "$user_id": {
          ".read": "auth.uid === $user_id",
          ".validate": "newData.hasChildren(['planId', 'stripeCustomerId', 'email', 'card'])",

          "planId": { ".validate": "newData.isString() && root.child('plans').hasChild(newData.val())" },
          "stripeCustomerId": { ".validate": "newData.isString() && newData.val().matches(/^cus_/)" },
          "email": { ".validate": "newData.isString() && newData.val().matches(/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,4}$/i)" },
          "card": {
            "brand": { ".validate": "newData.isString() && newData.val().length > 0" },
            "last4": { ".validate": "newData.isString() && newData.val().length > 0" },
            "expMonth": { ".validate": "newData.isString() && newData.val().length > 0" },
            "expYear": { ".validate": "newData.isString() && newData.val().length > 0" },

            "$other": { ".validate": false }
          },

          "$other": { ".validate": false }
        }
      },
      "teams": {
        ".write": "auth.uid === 'doorbell-firebase-server'",

        "$team_id": {
          ".read": "auth !== null && root.child('team_users').child($team_id).hasChild(auth.uid)",
          ".validate": "newData.hasChildren(['planId', 'stripeCustomerId', 'email', 'card'])",

          "planId": { ".validate": "newData.isString() && root.child('plans').hasChild(newData.val())" },
          "stripeCustomerId": { ".validate": "newData.isString() && newData.val().matches(/^cus_/)" },
          "email": { ".validate": "newData.isString() && newData.val().matches(/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,4}$/i)" },
          "card": {
            "brand": { ".validate": "newData.isString() && newData.val().length > 0" },
            "last4": { ".validate": "newData.isString() && newData.val().length > 0" },
            "expMonth": { ".validate": "newData.isString() && newData.val().length > 0" },
            "expYear": { ".validate": "newData.isString() && newData.val().length > 0" },

            "$other": { ".validate": false }
          },

          "$other": { ".validate": false }
        }
      },

      "$other": { ".validate": false }
    },

    "plans": {
      ".read": "auth !== null",
      ".write": false
    },

    "team_users": {
      ".read": "auth.uid === 'doorbell-firebase-server'",
      ".write": "auth.uid === 'doorbell-firebase-server'",

      "$team_id": {
        ".read": "auth !== null && data.hasChild(auth.uid)",
        ".validate": "root.child('teams').hasChild($team_id)",

        "$user_id": {
          ".validate": "root.child('users').hasChild($user_id) && newData.hasChildren(['email', 'private', 'roles'])",

          "title": { ".validate": "newData.isString()" },
          "email": { ".validate": "newData.isString() && newData.val().matches(/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,4}$/i)" },
          "private": { ".validate": "newData.isBoolean()" },
          "roles": {
            ".validate": "newData.hasChildren(['owner', 'admin', 'billing'])",

            "owner": { ".validate": "newData.isBoolean()" },
            "admin": { ".validate": "newData.isBoolean()" },
            "billing": { ".validate": "newData.isBoolean()" },

            "$other": { ".validate": false }
          },

          "$other": { ".validate": false }
        }
      }
    },

    "teams": {
      ".read": "auth.uid === 'doorbell-firebase-server'",
      ".write": "auth.uid === 'doorbell-firebase-server'",

      "$team_id": {
        ".read": "auth !== null && root.child('team_users').child($team_id).hasChild(auth.uid)",
        ".validate": "newData.hasChildren(['name', 'email'])",

        "name": { ".validate": "newData.isString() && newData.val().length > 0" },
        "email": { ".validate": "newData.isString() && newData.val().matches(/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,4}$/i)" },

        "$other": { ".validate": false }
      }
    },

    "users": {
      ".read": "auth.uid === 'doorbell-firebase-server'",
      ".write": "auth.uid === 'doorbell-firebase-server'",

      "$user_id": {
        ".read": "auth.uid === $user_id",
        ".validate": "newData.hasChildren(['provider', 'name', 'email'])",

        "provider": { ".validate": "newData.isString() && newData.val().length > 0" },
        "name": { ".validate": "newData.isString() && newData.val().length > 0" },
        "email": { ".validate": "newData.isString() && newData.val().matches(/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,4}$/i)" },

        "$other": { ".validate": false }
      }
    },

    "_queue": {
      ".read": "auth.uid === 'doorbell-firebase-server'",
      ".write": "auth !== null",

      "$task_id": {
        ".write": "auth.uid === 'doorbell-firebase-server'",
        ".validate": "newData.hasChildren(['_action', '_state', '_state_changed', '_owner', '_progress', '_error_details'])",

        "_action": { ".validate": "newData.isString() && newData.val().length > 0" },
        "_state": { ".validate": "newData.isString()" },
        "_stateChanged": { ".validate": "newData.isNumber() && (newData.val() === now || data.val() === newData.val())" },
        "_owner": { ".validate": "newData.isString()" },
        "_progress": { ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 100" },
        "_error": {
          "message": { ".validate": "newData.isString()" },
          "stack": { ".validate": "newData.isString()" },
          "previousState": { ".validate": "newData.isString()" },
          "originalTask": {},
          "attempts": { ".validate": "newData.isNumber() && newData.val() > 0" },

          "$other": { ".validate": false }
        }
      }
    }

  }
}
